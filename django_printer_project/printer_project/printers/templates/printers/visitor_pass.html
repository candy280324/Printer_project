<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gate Pass System</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        :root {
            --bs-primary: #007bff;
        }

        body {
            background-color: #eaf4fc;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .card {
            width: 800px;
            max-width: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: var(--bs-primary);
            color: white;
            text-align: center;
            font-size: 1.25rem;
            padding: 1rem;
        }

        table {
            width: 100%;
            min-width: 500px;
        }

        th,
        td {
            padding: .55rem .75rem;
            vertical-align: middle;
        }

        td input,
        td select,
        td span,
        td div {
            width: 100% !important;
            box-sizing: border-box;
            display: block;
        }

        .btn-print {
            width: 100%;
            font-size: 1.1rem;
        }

        .text-end {
            text-align: right;
        }

        .text_style {
            font-size: 1rem;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <div class="d-flex justify-content-center gap-3 mb-4">
            <button type="button" class="btn btn-outline-info"
                onclick="window.location.href='http://127.0.0.1:8000/gatepass/'">
                <i class="bi bi-door-open-fill me-1"></i>Gate Pass
            </button>
            <button type="button" class="btn btn-outline-info"
                onclick="window.location.href='http://127.0.0.1:8000/uniformslip/'">
                <i class="bi bi-universal-access me-1"></i>Uniform Slip
            </button>
        </div>

        <div class="card">
            <div class="card-header">Visitor Pass</div>
            <div class="card-body">
                <form method="post" novalidate id="gatepass-form" action="\visitorpass\">
                    {% csrf_token %}
                    <table class="table table-borderless align-middle mb-3">
                        <tbody>
                            <tr>
                                <th class="text-end">Date & In Time:</th>
                                <td><span id="today_date"></span>
                                    <input type="hidden" name="index_no" class="form-control" id="index_no"
                                        style="display: none;">
                                    <input type="hidden" name="session_login" id="session_login">
                                </td>
                            </tr>
                            <tr>
                                <th class="text-end">Category:</th>
                                <td>
                                    <select name="category" id="category" class="form-control" onchange="getOrg()">
                                        <option value="">-SELECT-</option>
                                        <option value="Vendor">Vendor</option>
                                        <option value="Customer">Customer</option>
                                        <option value="Government">Government</option>
                                        <option value="Others">Others</option>
                                    </select>
                                </td>
                                <th class="text-end">Organization:</th>
                                <td>
                                    <div id="org_type"></div>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-end">Name of the Visitor:</th>
                                <td><input type="text" class="form-control" placeholder="Enter Name" name="visitor"
                                        id="visitor" /></td>
                                <th class="text-end">Place / Mobile No:</th>
                                <td><input type="text" class="form-control" placeholder="Enter Place / Mobile"
                                        name="mobile_no" id="mobile_no" /></td>
                            </tr>
                            <tr>
                                <th class="text-end">Location:</th>
                                <td>
                                    <div id="location_name"></div>
                                </td>
                                <th class="text-end">Department:</th>
                                <td>
                                    <input type="hidden" id="department_name" name="department_name">
                                    <select name="department" id="department" class="form-control"
                                        onchange="getAssocDept()">
                                        <option value="">--SELECT--</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-end">Empcode:</th>
                                <td>
                                    <select name="empcode_list" id="empcode_list" class="form-control"
                                        onchange="getName()">
                                        <option value="">--SELECT--</option>
                                    </select>
                                </td>
                                <th class="text-end">Emp Name:</th>
                                <td><span id="selEmpname" class="text_style"></span>
                                    <input type="hidden" id="empcodeName" name="empcodeName">
                                </td>
                            </tr>
                            <tr>
                                <th class="text-end">Designation:</th>
                                <td><span id="selDesignation" class="text_style"></span></td>
                                <th class="text-end">Role:</th>
                                <td><span id="selRole" class="text_style"></span></td>
                            </tr>
                            <tr>
                                <th class="text-end">Visiting Place:</th>
                                <td><input type="text" class="form-control" placeholder="Enter visiting place"
                                        id="place" name="place" /></td>
                                <th class="text-end">Purpose of Visit:</th>
                                <td><input type="text" class="form-control" placeholder="Enter Purpose" id="purpose"
                                        name="purpose" /></td>
                            </tr>
                            <tr>
                                <th class="text-end">Belongings:</th>
                                <td colspan="3"><input type="text" class="form-control" placeholder="Enter Belongings"
                                        id="belongings" name="belongings" /></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-success btn-print" id="print-btn" onclick="saveInData()">
                        <i class="bi bi-printer-fill me-1"></i>Print
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            $.ajax({
                url: 'http://192.168.132.12/rewamp/index.php/leave/getAssocLst/1',
                type: 'post',
                success: function result(data) {
                    $("#empcode_list").empty().append(data).select2();
                }
            });
            const currentDate = new Date();
            const day = String(currentDate.getDate()).padStart(2, '0');
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const year = currentDate.getFullYear();
            const minutes = String(currentDate.getMinutes()).padStart(2, '0');
            const time = `${currentDate.getHours()}:${minutes}`;
            const formattedDate = `${day}-${month}-${year} ${time}`;
            $("#today_date").text(formattedDate);

            $.ajax({
                url: 'http://192.168.132.12/rewamp/index.php/leave/locationMaster',
                type: 'get',
                async: false,
                success: function (data) {
                    $("#location_name").html(data);
                }
            });
            $.ajax({
                url: 'http://192.168.132.12/rewamp/index.php/leave/getDeptLst',
                type: 'get',
                async: false,
                success: function (data) {
                    $("#department").html(data);
                }
            });

            $('#location').change(function () {
                var loc = $("#location").val();
                $.post('http://192.168.132.12/rewamp/index.php/leave/getDeptList', { 'Jloc': loc }, function (data) {
                    $("#department").html(data.dept_list);
                }, 'json');
                // $.post('http://192.168.132.12/rewamp/index.php/leave/getEmpcodedata', { 'Jloc': loc }, function (data) {
                //     $("#session_login").val(data.empcode_data);
                // }, 'json');
            });
        });

        function getOrg() {
            var cat = $("#category").val();
            var sel;
            if (cat == "Vendor") {
                $.ajax({
                    url: 'http://192.168.132.12/rewamp/index.php/leave/getVenLst',
                    type: 'get',
                    async: false,
                    success: function result(data) {
                        sel = '<select name="organaization" id="organaization" class="form-control">' + data + '</select>';
                        $("#org_type").empty().append(sel); // ✅ insert first
                        $('#organaization').select2();      // ✅ then initialize
                    },
                });
            } else {
                sel = '<input type="text" name="organaization" id="organaization" class="form-control"  style="text-transform:uppercase">';
                $("#org_type").empty().append(sel);
            }
        }
        function getAssocDept() {
            var dept = $("#department").val();
            let selectedText = $('#department option:selected').text();
            $("#department_name").empty().val(selectedText);
            $.ajax({
                url: 'http://192.168.132.12/rewamp/index.php/leave/getAssocLst/' + dept,
                type: 'post',
                success: function result(data) {
                    $("#empcode_list").empty().append(data).select2();
                }
            });
        }
        function getName() {
            let selectedName = $('#empcode_list').val();
            // var dept = $("#department").val();
            // let selectedText = $('#department option:selected').text();
            // $("#department_name").empty().val(selectedText);
            $.ajax({
                url: 'http://192.168.132.12/rewamp/index.php/leave/getAssociate/' + selectedName,
                type: 'post',
                success: function result(data) {
                    const [empName, department, designation, role, location, deptcode, leave, session_login] = data.split('$');
                    $("#selEmpname,#empcodeName").empty().append(empName);
                    $("#selDesignation").empty().append(designation);
                    $("#selRole").empty().append(role);
                    $("#location").val(location);
                    $("#department").val(deptcode);
                    $("#session_login").val(session_login);
                }
            });
            // $("#empcodeName").empty().val(selectedName);
        }
        function saveInData() {
            var cat = $("#category").val();
            var org = $("#organaization").val();
            var visitor = $("#visitor").val();
            var associate = $("#empcode_list").val();
            var place = $("#place").val();
            var purpose = $("#purpose").val();
            const session_login = $('#session_login').val();
            // var type = $("#type" + slno).val();

            var count = $("#count").val();
            if ($("#category").val() == '') {
                alert('Please fill up the data');
                $("#category").focus();
                return false;
            }
            if ($("#visitor").val() == '') {
                alert('Please fill up the data');
                $("#visitor").focus();
                return false;
            }
            if ($("#organaization").val() == '') {
                alert('Please fill up the data');
                $("#organaization").focus();
                return false;
            }
            if ($("#empcode_list").val() == '') {
                alert('Please fill up the data');
                $("#empcode_list").focus();
                return false;
            }
            if ($("#today_intime").val() == '') {
                alert('Please click on Out time');
                $("#today_intime").focus();
                return false;
            }
            if ($("#place").val() == '') {
                alert('Please fill up the data');
                $("#place").focus();
                return false;
            }
            if ($("#purpose").val() == '') {
                alert('Please fill up the data');
                $("#purpose").focus();
                return false;
            }
            var today = new Date();
            var minu = today.getMinutes();
            if (minu < 10) {
                minu = '0' + minu;
            }
            var todayTime = today.getHours() + ":" + minu;
            $.ajaxSetup({ async: false });
            $.post('http://192.168.132.12/rewamp/index.php/leave/insertVisit',
                { 'Jassociate': associate, 'Jplace': place, 'Jpurpose': purpose, 'Jtype': "", 'Jin': todayTime, 'cat': cat, 'org': org, 'visitor': visitor, 'Jsession': session_login },
                function (data) {
                    if (data.msg == 'succ') {
                        $("#index_no").val(data.oid)
                        $('#gatepass-form').submit();
                    } else if (data.msg == 'update') {

                        alert('Previous action of Out/In of same date not closed, first close that and enter again');
                        return false;
                    } else if (data.msg == 'error') {

                        alert('Record Already exists');
                        return false;
                    } else if (data.msg == 'databaseerror') {

                        alert('Database error occured');
                        return false;
                    }
                }, 'json');
            $.ajaxSetup({ async: true });
        }
    </script>
    <!-- Your existing scripts remain the same -->
</body>

</html>